name: Pull Request

on:
  pull_request:
  
env:
  KUBECONFIG: /tmp/config

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: x64
      - name: Install Python dependencies
        uses: py-actions/py-dependency-install@v2
        with:
          path: "scripts/requirements.txt"

      - name: Setup kubectl
        uses: azure/setup-kubectl@v1
        with:
          version: 'v1.19.10'
      - name: Setup kustomize
        uses: yokawasa/action-setup-kube-tools@v0.7.1
        with:
          kustomize: '3.8.3'
      - name: Setup helm & helmfile
        uses: mamezou-tech/setup-helmfile@v0.8.0
        with:
          helmfile-version: "v0.140.0"
          helm-version: "v3.3.1"
          install-kubectl: no
  
      - name: Setup kubeconfig
        run: |
          echo "$KUBERNETES_CONFIG" | base64 -d > $KUBECONFIG
        shell: bash
        env:
          KUBERNETES_CONFIG: ${{ secrets.KUBERNETES_CONFIG }}

      - name: Diff applications
        run: |
          make diff

      - name: Dryrun applications
        run: |
          make dryrun
