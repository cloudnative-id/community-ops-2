name: Master

on:
  push:
    branches:
    - master

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: x64
      - name: Install Python dependencies
        uses: py-actions/py-dependency-install@v2
        with:
          path: "scripts/requirements.txt"
      - name: Setup helm
        uses: azure/setup-helm@v1
        with:
          version: 'v3.3.1'
      - uses: azure/setup-kubectl@v1
        with:
          version: 'v1.19.10'
      # - name: deploy argocd manifest to cluster
      #   uses: steebchen/kubectl@v2.0.0
      #   with:
      #     version: v1.19.10
      #     config: ${{ secrets.KUBERNETES_CONFIG }}
      #     command: apply -f argocd/ -R
      - run: |
          echo "$KUBERNETES_CONFIG" | base64 -d > /tmp/config
        shell: bash
        env:
          KUBERNETES_CONFIG: ${{ secrets.KUBERNETES_CONFIG }}
      - name: deploy argocd manifest to cluster
        run: |
          kubectl --kubeconfig=/tmp/config apply -f argocd/ -R
