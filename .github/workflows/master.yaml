name: Master

on:
  push:
    branches:
    - master

env:
  KUBECONFIG: /tmp/config

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: x64
      - name: Install Python dependencies
        uses: py-actions/py-dependency-install@v2
        with:
          path: "scripts/requirements.txt"

      - name: Setup helm
        uses: azure/setup-helm@v1
        with:
          version: 'v3.3.1'
      - name: Setup kubectl
        uses: azure/setup-kubectl@v1
        with:
          version: 'v1.19.10'
      - name: Setup kustomize
        uses: karancode/kustomize-github-action@master
        with:
          kustomize_version: '3.8.3'
  
      - name: Setup kubeconfig
        run: |
          echo "$KUBERNETES_CONFIG" | base64 -d > $KUBECONFIG
        shell: bash
        env:
          KUBERNETES_CONFIG: ${{ secrets.KUBERNETES_CONFIG }}

      - name: Deploy applications
        run: |
          make deploy
